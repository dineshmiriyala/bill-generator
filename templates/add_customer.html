{% extends 'base.html' %}
{% block content %}
<div class="container d-flex flex-column justify-content-center align-items-center text-center py-4">
  <h2 class="mb-4">Add New Customer</h2>

  {% if duplicate %}
    <div class="alert alert-danger text-center w-100 mx-auto" role="alert" style="max-width: 500px; margin: 0 auto;">
      {{ error or 'Duplicate customer detected!' }}
    </div>
  {% endif %}

  {% if success %}
    <div class="alert alert-success text-center w-100 mx-auto" role="alert" style="max-width: 500px; margin: 0 auto;">
      {{ success_message or 'Customer added successfully!' }}
    </div>
  {% endif %}

  <form method="POST" action="{{ next_url if next_url else '/create_customers' }}" class="w-100" style="max-width: 400px;">
    <div class="form-floating mb-3">
      <input type="text" class="form-control shadow-sm" id="company" name="company" placeholder="Company Name" value="{{ company or '' }}">
      <label for="company">Company Name</label>
      <div class="form-text text-muted">Note: Only the company name will be displayed on the invoice.</div>
    </div>

    <div class="mb-3">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="form-floating">
            <input type="text" class="form-control shadow-sm" id="name" name="name" placeholder="Customer Name" value="{{ name or '' }}" required>
            <label for="name">Customer Name</label>
          </div>
        </div>
        <div class="col-auto">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="same_as_company" name="same_as_company">
            <label class="form-check-label" for="same_as_company">Same as Company</label>
          </div>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="form-floating">
            <input type="tel" class="form-control shadow-sm" id="phone" name="phone" placeholder="Phone Number" value="{{ phone or '' }}" required>
            <label for="phone">Phone Number</label>
          </div>
        </div>
        <div class="col-auto">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" value="1" id="use_auto_id" name="use_auto_id" {% if use_auto_id %}checked{% endif %}>
            <label class="form-check-label" for="use_auto_id">Use computer-generated ID</label>
          </div>
        </div>
      </div>
    </div>

    <div class="form-floating mb-3">
      <input type="email" class="form-control shadow-sm" id="email" name="email" placeholder="Email Address" value="{{ email or '' }}">
      <label for="email">Email Address (optional)</label>
    </div>

    <div class="form-floating mb-3">
      <input type="text" class="form-control shadow-sm" id="gst" name="gst" placeholder="GST Number" value="{{ gst or '' }}">
      <label for="gst">GST Number (optional)</label>
    </div>

    <div class="form-floating mb-3">
      <input type="text" class="form-control shadow-sm" id="businessType" name="businessType" placeholder="Business Type" value="{{ businessType or '' }}">
      <label for="businessType">Business Type (optional)</label>
    </div>

    <div class="form-floating mb-4">
      <textarea class="form-control shadow-sm" placeholder="Address" id="address" name="address" style="height: 100px;">{{ address or '' }}</textarea>
      <label for="address">Address (optional)</label>
    </div>

    <button type="submit" class="custom-btn w-100">Add Customer</button>
    <script>
      (function() {
        const cb = document.getElementById('use_auto_id');
        const phone = document.getElementById('phone');
        function sync() {
          if (!cb || !phone) return;
          if (cb.checked) {
            // remember current value to restore later
            if (!phone.dataset.prev) {
              phone.dataset.prev = phone.value || '';
            }
            phone.value = '';
            phone.setAttribute('data-was-required', phone.required ? '1' : '0');
            phone.required = false;
            phone.placeholder = 'Will be auto-generated';
            phone.disabled = true; // make it non-editable and excluded from submission
            phone.classList.add('bg-light');
          } else {
            phone.disabled = false;
            phone.classList.remove('bg-light');
            if (phone.getAttribute('data-was-required') !== '0') phone.required = true;
            phone.placeholder = 'Phone Number';
            // restore previous value if any
            if (phone.dataset.prev !== undefined) {
              phone.value = phone.dataset.prev;
              delete phone.dataset.prev;
            }
          }
        }
        document.addEventListener('DOMContentLoaded', sync);
        if (cb) cb.addEventListener('change', sync);

        // --- Same as Company toggle for Customer Name ---
        document.addEventListener('DOMContentLoaded', function() {
          const sameAsCompany = document.getElementById('same_as_company');
          const nameField = document.getElementById('name');
          const companyField = document.getElementById('company');

          function syncNameWithCompany() {
            if (!sameAsCompany || !nameField || !companyField) return;
            if (sameAsCompany.checked) {
              nameField.dataset.prev = nameField.value || '';
              nameField.value = companyField.value;
              nameField.readOnly = true;
              nameField.classList.add('bg-light');
            } else {
              nameField.readOnly = false;
              nameField.classList.remove('bg-light');
              if (nameField.dataset.prev !== undefined) {
                nameField.value = nameField.dataset.prev;
                delete nameField.dataset.prev;
              }
            }
          }

          if (sameAsCompany) {
            sameAsCompany.addEventListener('change', syncNameWithCompany);
          }
          if (companyField) {
            companyField.addEventListener('input', () => {
              if (sameAsCompany && sameAsCompany.checked) {
                nameField.value = companyField.value;
              }
            });
          }
        });
      })();
    </script>
  </form>
</div>
{% endblock %}