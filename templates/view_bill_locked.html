{% extends 'base.html' %}
{% block content %}
{% if new_bill == True %}
  {% set back_to_select_customer = True %}
{% else %}
  {% set back_to_select_customer = False %}
{% endif %}
<div class="container py-4 text-center">
  {% if session.persistent_notice %}
    <div style="background-color: #d1e7dd; border: 1px solid #badbcc; color: #0f5132; padding: 12px 16px; border-radius: 4px; position: relative; margin-bottom: 1rem;">
      <span style="font-weight: 500;">{{ session.persistent_notice }}</span>
      <button onclick="this.parentElement.style.display='none';" style="position: absolute; top: 8px; right: 12px; background: none; border: none; font-size: 20px; color: #0f5132; cursor: pointer;">Ã—</button>
      {% set _ = session.pop('persistent_notice') %}
    </div>
  {% endif %}
  <div class="mb-4">
    <h2 class="fw-semibold mb-1">View Bill</h2>
    <div class="text-muted small mb-4">Invoice No: <strong>{{ invoice_no }}</strong></div>
  </div>
  <div class="d-flex justify-content-center gap-2 mb-4">
    <a class="btn btn-warning shadow-sm" href="{{ url_for('edit_bill', invoicenumber=invoice_no) }}">Edit</a>
    <a class="btn btn-secondary shadow-sm" target="_blank" href="{{ url_for('bill_preview', invoicenumber=invoice_no) }}">Print Bill</a>
    <form id="deleteForm" method="POST" action="{{ url_for('delete_bill', invoicenumber=invoice_no) }}" class="d-inline">
      <input type="hidden" name="next" id="nextField" value="">
      <button type="submit" class="btn btn-danger shadow-sm">Delete</button>
    </form>
    <a class="btn btn-info shadow-sm" href="{{ url_for('test_pre_preview') }}">PDF Editor</a>
  </div>

  <h4 class="fw-medium mb-3">Customer Details</h4>
  <div class="table-responsive shadow-sm mb-5">
    <table class="table table-striped table-bordered align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Company</th>
          <th>Phone/ID</th>
          <th>GST</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ customer.name }}</td>
          <td>{{ customer.company }}</td>
          <td>{{ customer.phone }}</td>
          <td>{{ customer.gst }}</td>
          <td>{{ customer.address }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4 class="fw-medium mb-3">Items</h4>
  <div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:6rem;">Serial No</th>
          <th>Description</th>
          {% if dcno %}<th>Delivery Challan No</th>{% endif %}
          <th style="width:10rem;">Quantity</th>
          <th style="width:10rem;">Rate</th>
          <th style="width:12rem;" class="text-end">Line Total</th>
        </tr>
      </thead>
      <tbody>
        {% for desc, qty, rate in zip(descriptions, quantities, rates) %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ desc }}</td>
          {% if dcno %}
            <td>{{ dc_numbers[loop.index0] if dc_numbers is defined and dc_numbers|length > loop.index0 else '' }}</td>
          {% endif %}
          <td>{{ '%.2f' | format(qty) }}</td>
          <td>{{ '%.2f' | format(rate) }}</td>
          <td class="text-end">{{ '%.2f' | format(line_totals[loop.index0]) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="{% if dcno %}5{% else %}4{% endif %}" class="text-end">Total</th>
          <th class="text-end">{{ '%.2f' | format(total) }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  console.log("View Bill Locked page loaded");
  (function(){
    const form = document.getElementById('deleteForm');
    const nextField = document.getElementById('nextField');
    if (!form || !nextField) return;

    // Prefer going back to the create bill page if no referrer
    const listFallback = '{{ url_for('select_customer') }}';
    const ref = document.referrer || '';
    if (ref.includes('/view_bills')) {
      nextField.value = ref;
    } else {
      nextField.value = listFallback;
    }

    form.addEventListener('submit', function(e){
      if (!confirm('Are you sure you want to delete this bill?')) {
        e.preventDefault();
      }
    });
  })();
</script>
{% endblock %}