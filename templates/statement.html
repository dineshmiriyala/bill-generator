{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="text-center fw-semibold mb-4">Date Wise Statements </h2>
  {% if error %}
  <div class="alert alert-warning" role="alert" style="margin: 12px 0;">
    {{ error }}
  </div>
  {% endif %}

  <form method="get" action="{{ url_for('statements') }}" class="mb-4">
    <div class="row justify-content-center align-items-end g-3">
      <div class="col-md-5 col-lg-4">
        <label for="scope" class="form-label fw-medium">Select Scope</label>
        <select name="scope" id="scope" class="form-select shadow-sm">
          <option value="month" {% if scope == 'month' %}selected{% endif %}>Month</option>
          <option value="year" {% if scope == 'year' %}selected{% endif %}>Year</option>
          <option value="custom" {% if scope == 'custom' %}selected{% endif %}>Custom</option>
        </select>
      </div>

      <div class="col-md-2 hidden" id="wrapYear">
        <label for="year" class="form-label fw-medium">Year</label>
        <input type="number" class="form-control shadow-sm" name="year" id="year" min="2000" max="2100" value="{{ request.args.get('year','') }}">
      </div>

      <div class="col-md-2 hidden" id="wrapMonth">
        <label for="month" class="form-label fw-medium">Month</label>
        <input type="number" class="form-control shadow-sm" name="month" id="month" min="1" max="12" value="{{ request.args.get('month','') }}">
      </div>

      <div class="col-md-2 hidden" id="wrapStart">
        <label for="start" class="form-label fw-medium">Start Date</label>
        <input type="date" class="form-control shadow-sm" name="start" id="start" value="{{ request.args.get('start','') }}">
      </div>

      <div class="col-md-2 hidden" id="wrapEnd">
        <label for="end" class="form-label fw-medium">End Date</label>
        <input type="date" class="form-control shadow-sm" name="end" id="end" value="{{ request.args.get('end','') }}">
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100 shadow-sm">Get Statements</button>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <a href="{{ url_for('statements_company') }}" class="btn btn-outline-secondary w-100 shadow-sm" style="border-radius: 6px;">
          Company Wise
        </a>
      </div>
    </div>
  </form>

  {% if request.args and total_invoices > 0 %}
  <div class="text-center mb-3">
    <a class="btn btn-success shadow-sm" id="csvLink" href="#" target="_blank">Download CSV</a>
  </div>
  <div class="text-center mb-4">
    <div class="muted">Range: <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong></div>
    <div style="margin-top:6px;">Total invoices: <strong>{{ total_invoices }}</strong> | Total amount: <strong>{{ '%.2f'|format(total_amount) }}</strong></div>
    {% if phone %}<div class="muted">Filtered by phone/ID: <code>{{ phone }}</code></div>{% endif %}
  </div>

  <h3 class="text-center mb-3">Per-company breakdown</h3>
  <div class="table-responsive shadow-sm mb-4">
    <table class="table">
      <thead>
        <tr><th>Company</th><th class="text-end">Count</th><th class="text-end">Amount</th></tr>
      </thead>
      <tbody>
        {% for company, data in per_customer.items() %}
        <tr>
          <td>{{ company }}</td>
          <td class="text-end">{{ data['count'] }}</td>
          <td class="text-end">{{ '%.2f'|format(data['amount']) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h3 class="text-center mb-3">Invoices</h3>
  <div class="table-responsive shadow-sm">
    <table class="table">
      <thead>
        <tr><th>#</th><th>Invoice No</th><th>Date</th><th>Company</th><th>Phone/ID</th><th class="text-end">Total</th></tr>
      </thead>
      <tbody>
        {% if inv_rows is defined and inv_rows %}
          {% for row in inv_rows %}
          <tr>
            <td>{{ loop.index }}</td>
            <td><a href="{{ url_for('view_bill_locked', invoicenumber=row.invoice_no) }}">{{ row.invoice_no }}</a></td>
            <td>{{ row.date }}</td>
            <td>{{ row.company }}</td>
            <td>{{ row.phone }}</td>
            <td class="text-end">{{ '%.2f'|format(row.total) }}</td>
          </tr>
          {% endfor %}
        {% else %}
          {# Fallback for legacy context if inv_rows wasn't provided #}
          {% for inv in invs %}
          <tr>
            <td>{{ loop.index }}</td>
            <td><a href="{{ url_for('view_bill_locked', invoicenumber=inv.invoiceId) }}">{{ inv.invoiceId }}</a></td>
            <td>{{ inv.createdAt.strftime('%Y-%m-%d') }}</td>
            <td>{{ inv.customer.company if inv.customer and inv.customer.company else '(No Company)' }}</td>
            <td>{{ inv.customer.phone if inv.customer else '' }}</td>
            <td class="text-end">{{ '%.2f'|format(inv.totalAmount or 0) }}</td>
          </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<style>
  .muted { color: #666; }
  .hidden { display: none; }

  td:nth-child(2),
  td:nth-child(3),
  th:nth-child(2),
  th:nth-child(3) {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .btn-sm {
    height: calc(2.5rem + 2px); /* match Bootstrap form-select height */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
  }
</style>

<script>
(function() {
  const scopeEl = document.getElementById('scope');
  const wrapYear = document.getElementById('wrapYear');
  const wrapMonth = document.getElementById('wrapMonth');
  const wrapStart = document.getElementById('wrapStart');
  const wrapEnd = document.getElementById('wrapEnd');
  const csvLink = document.getElementById('csvLink');

  const today = new Date();
  const yearEl = document.getElementById('year');
  const monthEl = document.getElementById('month');
  const startEl = document.getElementById('start');
  const endEl = document.getElementById('end');

  // Prefill with current date values
  if (yearEl && !yearEl.value) yearEl.value = today.getFullYear();
  if (monthEl && !monthEl.value) monthEl.value = today.getMonth() + 1;
  const todayStr = today.toISOString().split('T')[0];
  if (startEl && !startEl.value) startEl.value = todayStr;
  if (endEl && !endEl.value) endEl.value = todayStr;

  function toggleByScope() {
    const scope = scopeEl.value;
    // Hide all first
    wrapYear.classList.add('hidden');
    wrapMonth.classList.add('hidden');
    wrapStart.classList.add('hidden');
    wrapEnd.classList.add('hidden');

    if (scope === 'year') {
      wrapYear.classList.remove('hidden');
    } else if (scope === 'month') {
      wrapYear.classList.remove('hidden');
      wrapMonth.classList.remove('hidden');
    } else { // custom
      wrapStart.classList.remove('hidden');
      wrapEnd.classList.remove('hidden');
    }
  }

  function buildCsvHref() {
    const url = new URL(window.location.href);
    url.searchParams.set('format', 'csv');
    csvLink.href = url.toString();
  }

  scopeEl.addEventListener('change', toggleByScope);
  toggleByScope();
  buildCsvHref();
})();
</script>

{% endblock %}