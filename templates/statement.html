{% extends 'base.html' %}

{% block content %}
<div class="py-4">
  <div class="container" style="max-width: 1080px;">
    <h2 class="text-center fw-semibold mb-4">View Statements by Date</h2>

    <!-- ===== Simple, Reliable Search Bar ===== -->
    <form id="stmts-form" method="GET" action="{{ url_for('statements') }}">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">

            <!-- Scope -->
            <div class="col-12 col-md-3">
              <label for="scope" class="form-label fw-medium">Scope</label>
              <select id="scope" name="scope" class="form-select">
                <option value="month"  {% if scope == 'month'  %}selected{% endif %}>Month</option>
                <option value="year"   {% if scope == 'year'   %}selected{% endif %}>Year</option>
                <option value="custom" {% if scope == 'custom' %}selected{% endif %}>Custom</option>
              </select>
            </div>

            <!-- Year -->
            <div class="col-6 col-md-2" id="wrapYear">
              <label for="year" class="form-label fw-medium">Year</label>
              <input type="number" class="form-control" id="year" name="year"
                     min="2000" max="2100" value="{{ request.args.get('year','') }}">
            </div>

            <!-- Month -->
            <div class="col-6 col-md-2" id="wrapMonth">
              <label for="month" class="form-label fw-medium">Month</label>
              <input type="number" class="form-control" id="month" name="month"
                     min="1" max="12" value="{{ request.args.get('month','') }}">
            </div>

            <!-- Start -->
            <div class="col-6 col-md-3" id="wrapStart">
              <label for="start" class="form-label fw-medium">From</label>
              <input type="date" class="form-control" id="start" name="start" value="{{ request.args.get('start','') }}">
            </div>

            <!-- End -->
            <div class="col-6 col-md-3" id="wrapEnd">
              <label for="end" class="form-label fw-medium">To</label>
              <input type="date" class="form-control" id="end" name="end" value="{{ request.args.get('end','') }}">
            </div>
          </div>

          <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
            <button type="submit" class="btn btn-primary px-4">Get</button>
            <a href="{{ url_for('statements') }}" class="btn btn-outline-danger px-4">Clear</a>
            <a href="{{ url_for('statements_company') }}" class="btn btn-outline-secondary px-4">Company Wise</a>
          </div>
        </div>
      </div>
    </form>

    <!-- ===== Summary Card BELOW the search bar ===== -->
    {% if request.args and (total_invoices is defined) %}
    <div class="card border-0 rounded-4 shadow-sm mt-3">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
          <div class="fw-semibold">Summary</div>
          <div class="text-muted small">
            Invoices: <span class="fw-semibold text-dark">{{ total_invoices or 0 }}</span><br>
            Total Amount: <span class="fw-semibold text-dark">₹{{ '%.2f'|format(total_amount or 0) }}</span>
          </div>
          {% if start_date and end_date %}
          <div class="small mt-1">
            Range: <span class="fw-semibold text-dark">{{ start_date.strftime('%d %B %Y') }}</span> —
            <span class="fw-semibold text-dark">{{ end_date.strftime('%d %B %Y') }}</span>
          </div>
          {% endif %}
        </div>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-success rounded-pill px-4"
             href="{{ url_for('statements', export='csv',
                              scope=request.args.get('scope','custom'),
                              year=request.args.get('year'),
                              month=request.args.get('month'),
                              start=request.args.get('start'),
                              end=request.args.get('end')) }}"
             target="_blank" title="Download CSV">
             Download CSV
          </a>
          <a class="btn btn-info rounded-pill px-4"
             href="{{ url_for('statements', export='xlsx',
                              scope=request.args.get('scope','custom'),
                              year=request.args.get('year'),
                              month=request.args.get('month'),
                              start=request.args.get('start'),
                              end=request.args.get('end')) }}"
             target="_blank" title="Download XLSX">
             Download XLSX
          </a>
          <a class="btn btn-primary rounded-pill px-4"
             href="{{ url_for('statements', export='pdf',
                              scope=request.args.get('scope','custom'),
                              year=request.args.get('year'),
                              month=request.args.get('month'),
                              start=request.args.get('start'),
                              end=request.args.get('end')) }}"
             target="_blank" title="Save or Print PDF">
             Save/Print PDF
          </a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ===== Results Table ===== -->
    {% if request.args %}
      {% if total_invoices > 0 %}
      <div class="table-responsive mt-4">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr class="text-center">
              <th style="width: 48px;">#</th>
              <th>Invoice No</th>
              <th>Date</th>
              <th>Company</th>
              <th>Phone/ID</th>
              <th class="text-end">Total</th>
            </tr>
          </thead>
          <tbody>
            {% if inv_rows is defined and inv_rows %}
              {% for r in inv_rows %}
              <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td><a href="{{ url_for('view_bill_locked', invoicenumber=r.invoice_no) }}">{{ r.invoice_no }}</a></td>
                <td>{{ r.date.strftime('%d %B %Y') if r.date is not string else r.date }}</td>
                <td>{{ r.company }}</td>
                <td>{{ r.phone }}</td>
                <td class="text-end">₹{{ '%.2f'|format(r.total) }}</td>
              </tr>
              {% endfor %}
            {% else %}
              {% for inv in invs %}
              <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td><a href="{{ url_for('view_bill_locked', invoicenumber=inv.invoiceId) }}">{{ inv.invoiceId }}</a></td>
                <td>{{ inv.createdAt.strftime('%d %B %Y') }}</td>
                <td>{{ inv.customer.company if inv.customer and inv.customer.company else '(No Company)' }}</td>
                <td>{{ inv.customer.phone if inv.customer else '' }}</td>
                <td class="text-end">₹{{ '%.2f'|format(inv.totalAmount or 0) }}</td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-center text-muted mt-4">No statements found for the selected dates.</p>
      {% endif %}
    {% endif %}
  </div>
</div>

<style>
  /* Minimal, stable styling */
  #stmts-form .form-control, #stmts-form .form-select { height: 44px; }
  #stmts-form .btn { height: 44px; white-space: nowrap; }
  table.table td, table.table th { font-size: 0.92rem; padding: 0.6rem; }
  a { text-decoration: none; }
  .form-control:focus, .form-select:focus {
    border-color: #007aff;
    box-shadow: 0 0 0 0.2rem rgba(0,122,255,.25);
    outline: none;
  }
</style>

<script>
// Robust, no-frills toggle logic (no animations)
(function() {
  const scopeEl  = document.getElementById('scope');
  const wrapYear = document.getElementById('wrapYear');
  const wrapMonth= document.getElementById('wrapMonth');
  const wrapStart= document.getElementById('wrapStart');
  const wrapEnd  = document.getElementById('wrapEnd');
  const yearEl   = document.getElementById('year');
  const monthEl  = document.getElementById('month');
  const startEl  = document.getElementById('start');
  const endEl    = document.getElementById('end');

  function setDefaultsIfEmpty() {
    const today = new Date();
    if (!yearEl.value)  yearEl.value  = today.getFullYear();
    if (!monthEl.value) monthEl.value = String(today.getMonth() + 1);
    const todayStr = today.toISOString().split('T')[0];
    if (!startEl.value) startEl.value = todayStr;
    if (!endEl.value)   endEl.value   = todayStr;
  }

  function toggleByScope() {
    const scope = scopeEl.value;
    // Hide all by default
    [wrapYear, wrapMonth, wrapStart, wrapEnd].forEach(el => el.classList.add('d-none'));
    if (scope === 'year') {
      wrapYear.classList.remove('d-none');
    } else if (scope === 'month') {
      wrapYear.classList.remove('d-none');
      wrapMonth.classList.remove('d-none');
    } else { // custom
      wrapStart.classList.remove('d-none');
      wrapEnd.classList.remove('d-none');
    }
  }

  setDefaultsIfEmpty();
  toggleByScope();
  scopeEl.addEventListener('change', toggleByScope);
})();
</script>
{% endblock %}