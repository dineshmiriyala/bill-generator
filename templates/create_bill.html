{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-center">{{ 'Edit Bill' if edit_mode else 'Create Bill' }}</h2>

  {% if edit_mode %}
  <div id="editModeBanner" class="bg-info bg-opacity-10 border border-info rounded p-3 d-flex justify-content-between align-items-center mb-3">
    <div>
      <strong>Editing Invoice:</strong>
      <span class="badge bg-secondary">{{ prev_invoice_no or invoice_no }}</span>
      <span class="ms-3 text-muted">Created at: {{ prev_created_at }}</span>
    </div>
    <a href="{{ url_for('bill_preview', invoicenumber=invoice_no) }}" target="_blank" class="btn btn-sm btn-outline-primary">Open current PDF</a>
  </div>
  {% endif %}

  <form method="POST" action="{% if edit_mode %}{{ url_for('update_bill', invoicenumber=invoice_no) }}{% else %}/create-bill{% endif %}">
    {% if edit_mode %}<input type="hidden" name="invoice_no" value="{{ invoice_no }}">{% endif %}

    <!-- Customer Details -->
    <div class="mb-4">
      <h5>Customer Details</h5>
      <table class="table table-striped table-bordered align-middle text-start">
        <thead class="table-light">
          <tr>
            <th>Name</th><th>Company</th><th>ID</th><th>GST</th><th>Address</th><th></th><th></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-muted fst-italic small">{{ customer.name if customer else '' }}</td>
            <td>{{ customer.company if customer else '' }}</td>
            <td><span id="phoneValue" class="d-block">{{ customer.phone if customer else '' }}</span></td>
            <td><span id="gstValue" class="d-block">{{ customer.gst if customer else '' }}</span></td>
            <td><span id="addressValue" class="d-block">{{ customer.address if customer else '' }}</span></td>
            <td>{% if not edit_mode %}<a href="{{ url_for('select_customer') }}" class="btn btn-sm btn-success">Change</a>{% endif %}</td>
            <td></td>
          </tr>
          <tr>
            <td></td><td></td>
            <td class="text-center align-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="excludePhone" name="exclude_phone"
                  {% if exclude_phone %}checked{% endif %}>
                <label class="form-check-label small" for="excludePhone">Exclude ID</label>
              </div>
            </td>
            <td class="text-center align-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="excludeGST" name="exclude_gst"
                  {% if exclude_gst %}checked{% endif %}>
                <label class="form-check-label small" for="excludeGST">Exclude GST</label>
              </div>
            </td>
            <td class="text-center align-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="excludeAddress" name="exclude_addr"
                  {% if exclude_addr %}checked{% endif %}>
                <label class="form-check-label small" for="excludeAddress">Exclude Address</label>
              </div>
            </td>
            <td></td><td></td>
          </tr>
        </tbody>
      </table>
      <input type="hidden" name="customer_phone" value="{{ customer.phone if customer else '' }}">
    </div>

    <hr>

    <!-- Delivery Challan toggle -->
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="toggleDC" {% if dcno %}checked{% endif %}>
      <label class="form-check-label" for="toggleDC">Include Delivery Challan No per item</label>
    </div>

    <!-- Items -->
    <h5 class="mb-3">Items</h5>
    <div id="items">
      <div id="items-header" class="row g-3 align-items-end mb-2 fw-semibold small text-muted">
        <div class="col-md-1">S.No</div>
        <div class="col-md-4">Description</div>
        <div class="col-md-2 dc-col" style="{% if not dcno %}display:none;{% endif %}">DC No</div>
        <div class="col-md-2">Qty</div>
        <div class="col-md-2">Unit Price</div>
        <div class="col-md-2">Total</div>
        <div class="col-md-1 text-end"></div>
      </div>
      {% if success or edit_mode %}
        {% for description, quantity, rate, line_total in zip(descriptions, quantities, rates, line_totals) %}
        <div class="row g-3 align-items-end mb-3 item-row" data-last-edited="">
          <div class="col-md-1 serial-col"><span class="serial-index">{{ loop.index }}</span></div>
          <div class="col-md-4">
            <input type="text" name="description[]" class="form-control item-description" list="inventoryList" value="{{ description }}" placeholder="Item description" required>
            <datalist id="inventoryList">{% for item in inventory %}<option value="{{ item.name }}">{% endfor %}</datalist>
          </div>
          <div class="col-md-2 dc-col" style="{% if not dcno %}display:none;{% endif %}">
            <input type="text" name="dc_no[]" class="form-control dc-input" value="{{ dc_numbers[loop.index0] if dc_numbers is defined and dc_numbers|length > loop.index0 else '' }}" {% if not dcno %}disabled{% endif %}>
          </div>
          <div class="col-md-2"><input type="number" name="quantity[]" class="form-control qty-input" step="1" value="{{ quantity }}" placeholder="Quantity" required></div>
          <div class="col-md-2"><input type="number" name="rate[]" class="form-control rate-input" step="0.01" value="{{ rate }}" placeholder="Unit price" required></div>
          <div class="col-md-2"><input type="number" name="total[]" class="form-control total-input" step="0.01" value="{{ line_total }}" placeholder="Line total" required></div>
          <div class="col-md-1 d-flex justify-content-end"><button type="button" class="btn btn-danger remove-item">Remove</button></div>
        </div>
        {% endfor %}
      {% else %}
        <div class="row g-3 align-items-end mb-3 item-row" data-last-edited="">
          <div class="col-md-1 serial-col"><span class="serial-index">1</span></div>
          <div class="col-md-4">
            <input type="text" name="description[]" class="form-control item-description" list="inventoryList" required placeholder="Item description">
            <datalist id="inventoryList">{% for item in inventory %}<option value="{{ item.name }}">{% endfor %}</datalist>
          </div>
          <div class="col-md-2 dc-col" style="display:none;"><input type="text" name="dc_no[]" class="form-control dc-input" disabled></div>
          <div class="col-md-2"><input type="number" name="quantity[]" class="form-control qty-input" step="1" placeholder="Quantity" required></div>
          <div class="col-md-2"><input type="number" name="rate[]" class="form-control rate-input" step="0.01" placeholder="Unit price" required></div>
          <div class="col-md-2"><input type="number" name="total[]" class="form-control total-input" step="0.01" placeholder="Line total" required></div>
          <div class="col-md-1 d-flex justify-content-end"><button type="button" class="btn btn-danger remove-item">Remove</button></div>
        </div>
      {% endif %}
    </div>

    <div class="mb-3"><button type="button" id="addItem" class="btn btn-secondary">Add Item</button></div>

    <!-- Grand Total -->
    <div class="mb-4 text-end pe-3">
      <label class="form-label fw-semibold">New Total (INR):</label>
      <span id="totalAmount" class="fw-bold fs-5">{{ grand_total if (success or edit_mode) and grand_total else '0.00' }}</span>
    </div>

    <!-- Action buttons -->
    {% if edit_mode %}
      <button type="submit" class="btn btn-primary">Update Bill</button>
      <button type="submit" id="createNewBillBtn" class="btn btn-success ms-2" formaction="/create-bill" formmethod="POST">Create New Bill</button>
      <a href="{{ url_for('select_customer') }}" class="btn btn-outline-secondary ms-2">Start Fresh</a>
    {% else %}
      <button type="submit" class="btn btn-primary">Generate Bill</button>
      <button type="button" id="clearForm" class="btn btn-outline-danger ms-2">Clear Form</button>
      {% if success and not edit_mode %}<a href="{{ url_for('latest_bill_preview') }}" target="_blank" class="btn btn-success ms-2" id="printBillBtn">Print Generated Bill</a>{% endif %}
    {% endif %}

    {% if edit_mode %}
    <div class="mt-3"><a href="{{ url_for('bill_preview', invoicenumber=invoice_no) }}" target="_blank" class="btn btn-outline-primary btn-sm">Preview Current Bill</a></div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success mt-4 d-flex justify-content-between align-items-center">
      <div>
        <strong>Bill {{ 'updated' if edit_mode else 'generated' }} successfully</strong>
        {% if invoice_no %}<span class="ms-2">(Invoice: <span class="badge bg-secondary">{{ invoice_no }}</span>)</span>{% endif %}
      </div>
      <a href="{{ url_for('bill_preview', invoicenumber=invoice_no) if edit_mode else url_for('latest_bill_preview') }}" target="_blank" class="btn btn-outline-primary btn-sm">Preview Bill</a>
    </div>
    {% endif %}
  </form>
</div>

<script>
function roundToNearest10(num) {
  return Math.round(num / 10) * 10;
}

function calculateTotal() {
  let grand = 0;
  document.querySelectorAll('.item-row').forEach(row => {
    const qtyInput = row.querySelector('[name="quantity[]"]');
    const rateInput = row.querySelector('[name="rate[]"]');
    const totalInput = row.querySelector('[name="total[]"]');
    const qty = parseFloat(qtyInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    const lastEdited = row.dataset.lastEdited;

    if (lastEdited === 'total') {
      let totalVal = parseFloat(totalInput.value) || 0;
      if (qty > 0) {
        rateInput.value = (totalVal / qty).toFixed(2);
      }
      grand += totalVal;
    } else {
      let total = qty * rate;
      total = roundToNearest10(total);
      totalInput.value = total ? total.toFixed(2) : '';
      grand += total;
    }
  });
  document.getElementById('totalAmount').textContent = grand.toFixed(2);
}

function setupRow(row){
  row.querySelector('[name="quantity[]"]').addEventListener('input', () => { row.dataset.lastEdited='quantity'; calculateTotal(); });
  row.querySelector('[name="rate[]"]').addEventListener('input', () => { row.dataset.lastEdited='rate'; calculateTotal(); });
  row.querySelector('[name="total[]"]').addEventListener('input', () => { row.dataset.lastEdited='total'; calculateTotal(); });
}

function renumberRows(){
  document.querySelectorAll('#items .item-row').forEach((row,i)=>{ row.querySelector('.serial-index').textContent = i+1; });
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.item-row').forEach(row=>setupRow(row));
  calculateTotal();

  document.getElementById('addItem').addEventListener('click', ()=>{
    const firstRow = document.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    newRow.querySelectorAll('input').forEach(inp=>inp.value='');
    newRow.dataset.lastEdited='';
    document.getElementById('items').appendChild(newRow);
    renumberRows();
    setupRow(newRow);
    calculateTotal();
  });

  document.getElementById('items').addEventListener('click', e=>{
    if(e.target.classList.contains('remove-item')){
      const row = e.target.closest('.item-row');
      if(document.querySelectorAll('.item-row').length>1){
        row.remove();
        renumberRows();
        calculateTotal();
      }
    }
  });
});
// Form validation for all item fields before submit
document.querySelector("form").addEventListener("submit", function(e) {
  let valid = true;
  document.querySelectorAll(".item-row").forEach(row => {
    row.querySelectorAll("input").forEach(inp => {
      if (!inp.value && inp.hasAttribute("required")) {
        valid = false;
      }
    });
  });
  if (!valid) {
    e.preventDefault();
    alert("Please fill in all item fields (description, quantity, unit price, and total) before submitting.");
  }
});
</script>
{% endblock %}