{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-center">{{ 'Edit Bill' if edit_mode else 'Create Bill' }}</h2>

  {% if edit_mode %}
  <div id="editModeBanner" class="bg-info bg-opacity-10 border border-info rounded p-3 d-flex justify-content-between align-items-center mb-3">
    <div>
      <strong>Editing Invoice:</strong>
      <span class="badge bg-secondary">{{ prev_invoice_no or invoice_no }}</span>
      <span class="ms-3 text-muted">Created at: {{ prev_created_at }}</span>
    </div>
    <a href="{{ url_for('bill_preview', invoicenumber=invoice_no) }}" target="_blank" class="btn btn-sm btn-outline-primary">Open current PDF</a>
  </div>
  {% endif %}

  <form method="POST" action="{% if edit_mode %}{{ url_for('update_bill', invoicenumber=invoice_no) }}{% else %}/create-bill{% endif %}">
    {% if edit_mode %}<input type="hidden" name="invoice_no" value="{{ invoice_no }}">{% endif %}

    <!-- Customer Details -->
    <div class="mb-4">
      <h5>Customer Details</h5>
      <table class="table table-striped table-bordered align-middle text-start">
        <thead class="table-light">
          <tr>
            <th>Name</th><th>Company</th><th>ID</th><th>GST</th><th>Address</th><th></th><th></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-muted fst-italic small">{{ customer.name if customer else '' }}</td>
            <td>{{ customer.company if customer else '' }}</td>
            <td><span id="phoneValue" class="d-block">{{ customer.phone if customer else '' }}</span></td>
            <td><span id="gstValue" class="d-block">{{ customer.gst if customer else '' }}</span></td>
            <td><span id="addressValue" class="d-block">{{ customer.address if customer else '' }}</span></td>
            <td>{% if not edit_mode %}<a href="{{ url_for('select_customer') }}" class="btn btn-sm btn-success">Change</a>{% endif %}</td>
            <td></td>
          </tr>
          <tr>
            <td></td><td></td>
            <td class="text-center align-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="excludePhone" name="exclude_phone"
                  {% if exclude_phone %}checked{% endif %}>
                <label class="form-check-label small" for="excludePhone">Exclude ID</label>
              </div>
            </td>
            <td class="text-center align-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="excludeGST" name="exclude_gst"
                  {% if exclude_gst %}checked{% endif %}>
                <label class="form-check-label small" for="excludeGST">Exclude GST</label>
              </div>
            </td>
            <td class="text-center align-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="excludeAddress" name="exclude_addr"
                  {% if exclude_addr %}checked{% endif %}>
                <label class="form-check-label small" for="excludeAddress">Exclude Address</label>
              </div>
            </td>
            <td></td><td></td>
          </tr>
        </tbody>
      </table>
      <input type="hidden" name="customer_phone" value="{{ customer.phone if customer else '' }}">
    </div>

    <hr>

    <!-- Delivery Challan toggle -->
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="toggleDC" {% if dcno %}checked{% endif %}>
      <label class="form-check-label" for="toggleDC">Include Delivery Challan No per item</label>
    </div>

    <!-- Items -->
    <h5 class="mb-3">Items</h5>
    <div id="items">
      {# Define grid classes for semantic columns #}
      {% set sno_cls = 'col-md-1' %}
      {% if dcno %}
        {% set desc_cls = 'col-md-3' %}
        {% set dc_cls = 'col-md-2 dc-col' %}
      {% else %}
        {% set desc_cls = 'col-md-5' %}
        {% set dc_cls = 'col-md-2 dc-col d-none' %}
      {% endif %}
      {% set qty_cls = 'col-md-1 qty-col' %}
      {% set rate_cls = 'col-md-2 rate-col' %}
      {% set total_cls = 'col-md-1 total-col' %}
      {% set actions_cls = 'col-md-2 actions-col' %}

      <div id="items-header" class="row g-2 align-items-center mb-2 fw-semibold small text-muted">
        <div class="{{ sno_cls }} d-flex justify-content-center align-items-center sno-col">S.No</div>
        <div class="{{ desc_cls }} d-flex align-items-center desc-col">Description</div>
        <div class="{{ dc_cls }} d-flex justify-content-center align-items-center">DC No</div>
        <div class="{{ qty_cls }} d-flex justify-content-center align-items-center">Qty</div>
        <div class="{{ rate_cls }} d-flex justify-content-center align-items-center">Unit Price</div>
        <div class="{{ total_cls }} d-flex justify-content-center align-items-center">Total</div>
        <div class="{{ actions_cls }} d-flex justify-content-center align-items-center">Actions</div>
      </div>
      {% if success or edit_mode %}
        {% for description, quantity, rate, line_total in zip(descriptions, quantities, rates, line_totals) %}
        <div class="row g-2 align-items-center mb-2 item-row" data-last-edited="">
          <div class="{{ sno_cls }} serial-col sno-col"><span class="serial-index">{{ loop.index }}</span></div>
          <div class="{{ desc_cls }} desc-col">
            <input type="text" name="description[]" class="form-control item-description" list="inventoryList" value="{{ description }}" placeholder="Item description" required>
          </div>
          <div class="{{ dc_cls }}">
            <input type="text" name="dc_no[]" class="form-control dc-input" value="{{ dc_numbers[loop.index0] if dc_numbers is defined and dc_numbers|length > loop.index0 else '' }}" {% if not dcno %}disabled{% endif %}>
          </div>
          <div class="{{ qty_cls }}"><input type="number" name="quantity[]" class="form-control qty-input" step="1" value="{{ quantity }}" placeholder="Qty" required></div>
          <div class="{{ rate_cls }}"><input type="number" name="rate[]" class="form-control rate-input" step="0.01" value="{{ rate }}" placeholder="Unit price" required></div>
          <div class="{{ total_cls }}"><input type="number" name="total[]" class="form-control total-input" step="0.01" value="{{ line_total }}" placeholder="Total" required></div>
          <div class="{{ actions_cls }} d-flex">
            <button type="button" class="btn btn-info btn-sm me-1 round-zero">Round</button>
            <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
          </div>
        </div>
        {% endfor %}
        <datalist id="inventoryList">{% for item in inventory %}<option value="{{ item.name }}">{% endfor %}</datalist>
      {% else %}
        <div class="row g-2 align-items-center mb-2 item-row" data-last-edited="">
          <div class="{{ sno_cls }} serial-col sno-col"><span class="serial-index">1</span></div>
          <div class="{{ desc_cls }} desc-col">
            <input type="text" name="description[]" class="form-control item-description" list="inventoryList" required placeholder="Item description">
          </div>
          <div class="{{ dc_cls }}">
            <input type="text" name="dc_no[]" class="form-control dc-input" disabled>
          </div>
          <div class="{{ qty_cls }}"><input type="number" name="quantity[]" class="form-control qty-input" step="1" placeholder="Qty" required></div>
          <div class="{{ rate_cls }}"><input type="number" name="rate[]" class="form-control rate-input" step="0.01" placeholder="Unit price" required></div>
          <div class="{{ total_cls }}"><input type="number" name="total[]" class="form-control total-input" step="0.01" placeholder="Total" required></div>
          <div class="{{ actions_cls }} d-flex">
            <button type="button" class="btn btn-info btn-sm me-1 round-zero">Round</button>
            <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
          </div>
        </div>
        <datalist id="inventoryList">{% for item in inventory %}<option value="{{ item.name }}">{% endfor %}</datalist>
      {% endif %}
    </div>

    <div class="mb-3">
      <button type="button" id="addItem" class="btn btn-secondary">Add Item</button>
      <button type="button" id="roundAll" class="btn btn-info ms-2">Round All</button>
    </div>
    <div class="text-muted small fst-italic mb-3">
      Note: The <strong>Round</strong> button adjusts that line's total to the nearest 10 (e.g., 1234 → 1230, 1236 → 1240).
    </div>

    <!-- Grand Total -->
    <div class="mb-4 text-end pe-3">
      <label class="form-label fw-semibold">New Total (INR):</label>
      <span id="totalAmount" class="fw-bold fs-5">{{ grand_total if (success or edit_mode) and grand_total else '0.00' }}</span>
    </div>

    <!-- Action buttons -->
    {% if edit_mode %}
      <button type="submit" class="btn btn-primary">Update Bill</button>
      <button type="submit" id="createNewBillBtn" class="btn btn-success ms-2" formaction="/create-bill" formmethod="POST">Create New Bill</button>
      <a href="{{ url_for('select_customer') }}" class="btn btn-outline-secondary ms-2">Start Fresh</a>
    {% else %}
      <button type="submit" class="btn btn-primary">Generate Bill</button>
      <button type="button" id="clearForm" class="btn btn-outline-danger ms-2">Clear Form</button>
      {% if success and not edit_mode %}<a href="{{ url_for('latest_bill_preview') }}" target="_blank" class="btn btn-success ms-2" id="printBillBtn">Print Generated Bill</a>{% endif %}
    {% endif %}

    {% if edit_mode %}
    <div class="mt-3"><a href="{{ url_for('bill_preview', invoicenumber=invoice_no) }}" target="_blank" class="btn btn-outline-primary btn-sm">Preview Current Bill</a></div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success mt-4 d-flex justify-content-between align-items-center">
      <div>
        <strong>Bill {{ 'updated' if edit_mode else 'generated' }} successfully</strong>
        {% if invoice_no %}<span class="ms-2">(Invoice: <span class="badge bg-secondary">{{ invoice_no }}</span>)</span>{% endif %}
      </div>
      <a href="{{ url_for('bill_preview', invoicenumber=invoice_no) if edit_mode else url_for('latest_bill_preview') }}" target="_blank" class="btn btn-outline-primary btn-sm">Preview Bill</a>
    </div>
    {% endif %}
  </form>
</div>

<script>
// Build price map from inventory safely
const priceMap = {};
{% if inventory %}
  {% for item in inventory %}
    priceMap[{{ item.name|tojson }}] = {{ (item.unitPrice or 0)|tojson }};
  {% endfor %}
{% endif %}

function roundToNearest10(num) {
  return Math.round(num / 10) * 10;
}

function calculateTotal() {
  let grand = 0;
  document.querySelectorAll('.item-row').forEach(row => {
    const qtyInput = row.querySelector('[name="quantity[]"]');
    const rateInput = row.querySelector('[name="rate[]"]');
    const totalInput = row.querySelector('[name="total[]"]');
    const qty = parseFloat(qtyInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    const lastEdited = row.dataset.lastEdited;

    if (lastEdited === 'total') {
      let totalVal = parseFloat(totalInput.value) || 0;
      if (qty > 0) {
        rateInput.value = (totalVal / qty).toFixed(2);
      }
      grand += totalVal;
    } else {
      let total = qty * rate;
      totalInput.value = total ? total.toFixed(2) : '';
      grand += total;
    }
  });
  document.getElementById('totalAmount').textContent = grand.toFixed(2);
}

function setupRow(row){
  const descInput = row.querySelector('[name="description[]"]');
  const rateInput = row.querySelector('[name="rate[]"]');
  const qtyInput = row.querySelector('[name="quantity[]"]');
  const totalInput = row.querySelector('[name="total[]"]');

  function maybeAutofill() {
    if (!descInput || !rateInput) return;
    const key = descInput.value;
    if (key in priceMap) {
      if (!rateInput.value || rateInput.dataset.autofilled === "true") {
        const v = parseFloat(priceMap[key]);
        rateInput.value = isNaN(v) ? priceMap[key] : v.toFixed(2);
        rateInput.dataset.autofilled = "true";
        row.dataset.lastEdited = 'rate';
        calculateTotal();
      }
    }
  }

  if (descInput) {
    descInput.addEventListener('input', maybeAutofill);
    descInput.addEventListener('change', maybeAutofill);
  }
  if (rateInput) {
    rateInput.addEventListener('input', () => {
      rateInput.dataset.autofilled = "false";
      row.dataset.lastEdited='rate';
      calculateTotal();
    });
  }
  if (qtyInput) {
    qtyInput.addEventListener('input', () => { row.dataset.lastEdited='quantity'; calculateTotal(); });
  }
  if (totalInput) {
    totalInput.addEventListener('input', () => { row.dataset.lastEdited='total'; calculateTotal(); });
  }
}

function renumberRows(){
  document.querySelectorAll('#items .item-row').forEach((row,i)=>{ row.querySelector('.serial-index').textContent = i+1; });
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.item-row').forEach(row=>setupRow(row));
  calculateTotal();

  document.getElementById('addItem').addEventListener('click', ()=>{
    const firstRow = document.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);

    // Clear all inputs in the cloned row
    newRow.querySelectorAll('input').forEach(inp=>{
      inp.value = '';
      // Make sure no readOnly state is carried over from a rounded row
      inp.readOnly = false;
      inp.classList.remove('bg-light');
    });

    // Reset row edit state
    newRow.dataset.lastEdited = '';

    // Ensure qty is explicitly editable (belt-and-suspenders)
    const newQty = newRow.querySelector('[name="quantity[]"]');
    if (newQty) {
      newQty.readOnly = false;
      newQty.classList.remove('bg-light');
    }

    // Reset autofill marker on rate
    const newRate = newRow.querySelector('[name="rate[]"]');
    if (newRate) newRate.dataset.autofilled = "false";

    // Append and rewire listeners
    document.getElementById('items').appendChild(newRow);
    renumberRows();
    setupRow(newRow);
    calculateTotal();
  });

  document.getElementById('roundAll').addEventListener('click', ()=>{
    document.querySelectorAll('.item-row').forEach(row=>{
      const qtyInput = row.querySelector('[name="quantity[]"]');
      const rateInput = row.querySelector('[name="rate[]"]');
      const totalInput = row.querySelector('[name="total[]"]');
      const qty = parseFloat(qtyInput?.value) || 0;
      const rate = parseFloat(rateInput?.value) || 0;
      let basis = parseFloat(totalInput.value) || (qty * rate);
      const rounded = roundToNearest10(basis);
      totalInput.value = rounded.toFixed(2);
      if(qty > 0){
        rateInput.value = (rounded / qty).toFixed(2);
      }
      // Lock qty after rounding
      qtyInput.readOnly = true;
      qtyInput.classList.add("bg-light");
      row.dataset.lastEdited = 'total';
    });
    calculateTotal();
  });

  document.getElementById('items').addEventListener('click', e=>{
    if(e.target.classList.contains('remove-item')){
      const row = e.target.closest('.item-row');
      if(document.querySelectorAll('.item-row').length>1){
        row.remove();
        renumberRows();
        calculateTotal();
      }
    }
    if(e.target.classList.contains('round-zero')){
      const row = e.target.closest('.item-row');
      const qtyInput = row.querySelector('[name="quantity[]"]');
      const rateInput = row.querySelector('[name="rate[]"]');
      const totalInput = row.querySelector('[name="total[]"]');
      const qty = parseFloat(qtyInput?.value) || 0;
      const rate = parseFloat(rateInput?.value) || 0;
      let basis = parseFloat(totalInput.value) || (qty * rate);
      const rounded = roundToNearest10(basis);
      totalInput.value = rounded.toFixed(2);
      if(qty > 0){
        rateInput.value = (rounded / qty).toFixed(2);
      }
      // Lock the quantity field after rounding
      qtyInput.readOnly = true;
      qtyInput.classList.add("bg-light");
      row.dataset.lastEdited = 'total';
      calculateTotal();
    }
  });

  // Clear Form button handler: clears all item rows except the first, resets the first row's inputs and state
  const clearBtn = document.getElementById('clearForm');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      const itemRows = document.querySelectorAll('#items .item-row');
      if (itemRows.length === 0) return;
      // Remove all but the first row
      itemRows.forEach((row, idx) => {
        if (idx > 0) row.remove();
      });
      // Reset the first row's inputs and state
      const firstRow = itemRows[0];
      if (firstRow) {
        // Reset all relevant inputs
        const descInput = firstRow.querySelector('[name="description[]"]');
        const dcInput = firstRow.querySelector('[name="dc_no[]"]');
        const qtyInput = firstRow.querySelector('[name="quantity[]"]');
        const rateInput = firstRow.querySelector('[name="rate[]"]');
        const totalInput = firstRow.querySelector('[name="total[]"]');
        if (descInput) descInput.value = '';
        if (dcInput) dcInput.value = '';
        if (qtyInput) {
          qtyInput.value = '';
          qtyInput.readOnly = false;
          qtyInput.classList.remove("bg-light");
        }
        if (rateInput) {
          rateInput.value = '';
          rateInput.dataset.autofilled = "false";
        }
        if (totalInput) totalInput.value = '';
        firstRow.dataset.lastEdited = '';
      }
      renumberRows();
      calculateTotal();
    });
  }

  // Handle Delivery Challan toggle
  document.getElementById('toggleDC').addEventListener('change', function(){
    const enabled = this.checked;
    // Show/Hide DC columns and enable/disable inputs
    document.querySelectorAll('.dc-col').forEach(col => {
      col.classList.toggle('d-none', !enabled);
      const input = col.querySelector('input');
      if (input) input.disabled = !enabled;
    });
    // Adjust Description width to keep grid sum = 12
    const headerDesc = document.querySelector('#items-header .desc-col');
    if (headerDesc) {
      headerDesc.classList.toggle('col-md-5', !enabled);
      headerDesc.classList.toggle('col-md-3', enabled);
    }
    document.querySelectorAll('#items .item-row .desc-col').forEach(el=>{
      el.classList.toggle('col-md-5', !enabled);
      el.classList.toggle('col-md-3', enabled);
    });
  });
});
// Form validation for all item fields before submit
document.querySelector("form").addEventListener("submit", function(e) {
  let valid = true;
  document.querySelectorAll(".item-row").forEach(row => {
    row.querySelectorAll("input").forEach(inp => {
      if (!inp.value && inp.hasAttribute("required")) {
        valid = false;
      }
    });
  });
  if (!valid) {
    e.preventDefault();
    alert("Please fill in all item fields (description, quantity, unit price, and total) before submitting.");
  }
});
</script>
{% endblock %}